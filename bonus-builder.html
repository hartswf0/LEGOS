<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEGOS System Diagram Builder</title>
    <style>
        :root {
            --primary: #3a7ca5;
            --secondary: #d9e5ec;
            --accent: #81c3d7;
            --dark: #2f2f2f;
            --light: #f5f5f5;
            --success: #4caf50;
            --danger: #e74c3c;
            --warning: #f39c12;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.3rem;
        }
        
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background-color: var(--secondary);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background-color: white;
            background-image: 
                linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        #diagram-canvas {
            min-width: 2000px;
            min-height: 1000px;
            position: relative;
        }
        
        .component-group {
            margin-bottom: 1.5rem;
        }
        
        .component-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }
        
        .component-title::before {
            content: '▶';
            display: inline-block;
            margin-right: 5px;
            font-size: 0.8rem;
            transform: rotate(90deg);
        }
        
        .component-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .component-btn {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.8rem;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 110px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .component-btn:hover {
            background-color: var(--accent);
            border-color: var(--primary);
            color: white;
        }
        
        .controls {
            padding: 0.5rem;
            display: flex;
            justify-content: space-between;
            background-color: var(--light);
            border-bottom: 1px solid #ddd;
        }
        
        .control-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .control-btn:hover {
            background-color: #2d6383;
        }
        
        .control-btn.secondary {
            background-color: var(--secondary);
            color: var(--dark);
        }
        
        .control-btn.secondary:hover {
            background-color: #c5d5e0;
        }
        
        .template-select {
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 0.8rem;
        }

        /* Diagram elements */
        .diagram-element {
            position: absolute;
            cursor: move;
            user-select: none;
        }
        
        .location-box {
            border: 2px solid #3a7ca5;
            border-radius: 5px;
            background-color: rgba(217, 229, 236, 0.6);
            min-width: 200px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
        }
        
        .location-header {
            background-color: #3a7ca5;
            color: white;
            padding: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 14px;
            border-radius: 3px 3px 0 0;
        }
        
        .location-content {
            flex: 1;
            padding: 10px;
            position: relative;
        }
        
        .entity-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #2f2f2f;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .goal-box {
            border: 2px solid #4caf50;
            border-radius: 5px;
            background-color: rgba(220, 237, 220, 0.6);
            min-width: 120px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
        }
        
        .goal-header {
            background-color: #4caf50;
            color: white;
            padding: 3px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            border-radius: 3px 3px 0 0;
        }
        
        .goal-content {
            flex: 1;
            padding: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .obstacle-box {
            border: 2px solid #e74c3c;
            border-radius: 5px;
            background-color: rgba(242, 222, 222, 0.6);
            min-width: 100px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
        }
        
        .obstacle-header {
            background-color: #e74c3c;
            color: white;
            padding: 3px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            border-radius: 3px 3px 0 0;
        }
        
        .obstacle-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .shift-box {
            border: 2px solid #2f2f2f;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.6);
            min-width: 100px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
        }
        
        .shift-header {
            background-color: #2f2f2f;
            color: white;
            padding: 3px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            border-radius: 3px 3px 0 0;
        }
        
        .shift-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .solution-box {
            border: 2px solid #4caf50;
            border-radius: 5px;
            background-color: rgba(220, 237, 220, 0.6);
            min-width: 100px;
            min-height: 60px;
            display: flex;
            flex-direction: column;
        }
        
        .solution-header {
            background-color: #4caf50;
            color: white;
            padding: 3px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            border-radius: 3px 3px 0 0;
        }
        
        .solution-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }
        
        .arrow {
            height: 30px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .arrow-line {
            height: 2px;
            background-color: #2f2f2f;
            width: 100%;
            position: relative;
        }
        
        .arrow-head {
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 10px solid #2f2f2f;
            position: absolute;
            right: -9px;
            top: -5px;
        }
        
        .arrow-label {
            position: absolute;
            background-color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            border: 1px solid #ddd;
        }
        
        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        
        /* Styles for different diagram types */
        .active-template {
            background-color: rgba(129, 195, 215, 0.1);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            padding: 20px;
            margin: 20px;
            min-height: 300px;
        }
        
        .template-title {
            text-align: center;
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }
        
        .ascii-view {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #2f2f2f;
            color: #f0f0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            max-width: 400px;
            max-height: 200px;
            overflow: auto;
            z-index: 100;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            width: 400px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: #f5f5f5;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: white;
            border-color: #ddd;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .arrow-svg {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        .arrow-line {
            stroke: #3a7ca5;
            stroke-width: 3px;
            marker-end: url(#arrowhead);
        }
        .arrow-label {
            fill: #3a7ca5;
            font-size: 14px;
            font-weight: bold;
            pointer-events: none;
        }
        .connect-btn {
            background: #81c3d7;
            color: #2f2f2f;
            border-radius: 4px;
            padding: 0.3em 0.8em;
            font-size: 1em;
            margin-bottom: 0.7em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background 0.18s;
        }
        .connect-btn.active {
            background: #f39c12;
            color: #fff;
        }
    </style>
</head>
<body>
    <header>
        <h1>LEGOS System Diagram Builder</h1>
        <div class="subtitle">Location • Entity • Goal • Obstacle • Shift/Solution</div>
    </header>
    
    <div class="controls">
        <div>
            <select class="template-select" id="template-select">
                <option value="blank">Blank Canvas</option>
                <option value="basic-state">Basic State Diagram</option>
                <option value="walk-cycle">Walk Cycle Interpolation</option>
                <option value="logical-structure">Logical Structure Graph</option>
                <option value="temporal">Temporal Transition</option>
                <option value="dialogue-tree">NPC Dialogue Tree</option>
                <option value="circle-crossing">Abstract Circle-Crossing</option>
            </select>
            <button class="control-btn secondary" id="load-template">Load Template</button>
        </div>
        <div>
            <button class="connect-btn" id="connect-mode">Connect Blocks</button>
            <button class="control-btn secondary" id="toggle-ascii">Toggle ASCII View</button>
            <button class="control-btn secondary" id="export-btn">Export</button>
            <button class="control-btn" id="clear-btn">Clear Canvas</button>
        </div>
    </div>
    
    <main>
        <div class="sidebar">
            <div class="component-group">
                <div class="component-title">Basic Components</div>
                <div class="component-buttons">
                    <div class="component-btn" draggable="true" data-type="location">
                        🏠 Location
                    </div>
                    <div class="component-btn" draggable="true" data-type="entity">
                        🧑 Entity
                    </div>
                    <div class="component-btn" draggable="true" data-type="goal">
                        🎯 Goal
                    </div>
                    <div class="component-btn" draggable="true" data-type="obstacle">
                        ⛔ Obstacle
                    </div>
                    <div class="component-btn" draggable="true" data-type="shift">
                        🔄 Shift
                    </div>
                    <div class="component-btn" draggable="true" data-type="solution">
                        🏆 Solution
                    </div>
                </div>
            </div>
            
            <div class="component-group">
                <div class="component-title">Connectors</div>
                <div class="component-buttons">
                    <div class="component-btn" draggable="true" data-type="arrow">
                        Shift Arrow
                    </div>
                    <div class="component-btn" draggable="true" data-type="relation">
                        Relationship
                    </div>
                </div>
            </div>
            
            <div class="component-group">
                <div class="component-title">Template Blocks</div>
                <div class="component-buttons">
                    <div class="component-btn" draggable="true" data-type="entity-goal">
                        Entity + Goal
                    </div>
                    <div class="component-btn" draggable="true" data-type="state-transition">
                        State Transition
                    </div>
                    <div class="component-btn" draggable="true" data-type="dialogue-node">
                        Dialogue Node
                    </div>
                </div>
            </div>
            
            <div class="component-group">
                <div class="component-title">Templates</div>
                <div class="component-buttons">
                    <button class="control-btn" id="template-minimal">Minimal Loop</button>
                    <button class="control-btn" id="template-cyber">Cybernetic</button>
                    <button class="control-btn" id="template-quest">Quest</button>
                </div>
            </div>
        </div>
        
        <div class="canvas-container">
            <svg class="arrow-svg" id="arrow-svg"></svg>
            <div id="diagram-canvas"></div>
            
            <div class="legend">
                <div class="legend-title">LEGOS Legend</div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(217, 229, 236, 0.6);"></div>
                    <span>Location</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffffff; border-radius: 50%;"></div>
                    <span>Entity</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(220, 237, 220, 0.6);"></div>
                    <span>Goal</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: rgba(242, 222, 222, 0.6);"></div>
                    <span>Obstacle</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2f2f2f; height: 2px;"></div>
                    <span>Shift/Solution</span>
                </div>
            </div>
            
            <div class="ascii-view" id="ascii-view" style="display: none;">
# LEGOS ASCII Representation
+------------------------+
|        Location        |
|   +------------------+ |
|   |       Goal       | |
|   |     +-----+      | |
|   |     |  O  |      | |
|   |     +-----+      | |
|   +------------------+ |
+------------------------+
            </div>
        </div>
    </main>
    
    <!-- Edit Modal -->
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Component</h3>
                <button class="close-btn">&times;</button>
            </div>
            
            <div class="tab-container">
                <div class="tab active" data-tab="basic">Basic</div>
                <div class="tab" data-tab="style">Style</div>
                <div class="tab" data-tab="advanced">Advanced</div>
            </div>
            
            <div class="tab-content active" data-tab-content="basic">
                <div class="form-group">
                    <label class="form-label" for="component-name">Name/Label</label>
                    <input type="text" id="component-name" class="form-input" placeholder="Enter name or label">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="component-description">Description (optional)</label>
                    <input type="text" id="component-description" class="form-input" placeholder="Brief description">
                </div>
            </div>
            
            <div class="tab-content" data-tab-content="style">
                <div class="form-group">
                    <label class="form-label" for="component-color">Color</label>
                    <input type="color" id="component-color" class="form-input" value="#3a7ca5">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="component-size">Size</label>
                    <select id="component-size" class="form-input">
                        <option value="small">Small</option>
                        <option value="medium" selected>Medium</option>
                        <option value="large">Large</option>
                    </select>
                </div>
            </div>
            
            <div class="tab-content" data-tab-content="advanced">
                <div class="form-group">
                    <label class="form-label" for="component-id">Component ID</label>
                    <input type="text" id="component-id" class="form-input" placeholder="Auto-generated" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="component-type">Type</label>
                    <input type="text" id="component-type" class="form-input" placeholder="Component type" disabled>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="control-btn secondary" id="cancel-edit">Cancel</button>
                <button class="control-btn" id="save-edit">Save Changes</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const canvas = document.getElementById('diagram-canvas');
            const templateSelect = document.getElementById('template-select');
            const loadTemplateBtn = document.getElementById('load-template');
            const toggleAsciiBtn = document.getElementById('toggle-ascii');
            const asciiView = document.getElementById('ascii-view');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const componentBtns = document.querySelectorAll('.component-btn');
            const editModal = document.getElementById('edit-modal');
            const closeModalBtn = editModal.querySelector('.close-btn');
            const cancelEditBtn = document.getElementById('cancel-edit');
            const saveEditBtn = document.getElementById('save-edit');
            const tabs = document.querySelectorAll('.tab');
            const connectBtn = document.getElementById('connect-mode');
            const arrowSVG = document.getElementById('arrow-svg');
            
            // State
            let currentId = 1;
            let draggedElement = null;
            let dragOffsetX = 0;
            let dragOffsetY = 0;
            let currentlyEditing = null;
            let connections = [];
            let isConnecting = false;
            let startConnectElement = null;
            let connectMode = false;
            let connectFrom = null;
            
            // Event Listeners for Draggable Components
            componentBtns.forEach(btn => {
                btn.addEventListener('dragstart', handleDragStart);
            });
            
            canvas.addEventListener('dragover', handleDragOver);
            canvas.addEventListener('drop', handleDrop);
            
            // Handle Modal Events
            closeModalBtn.addEventListener('click', closeModal);
            cancelEditBtn.addEventListener('click', closeModal);
            saveEditBtn.addEventListener('click', saveEdit);
            
            // Handle Tab Switching
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    const tabName = this.getAttribute('data-tab');
                    document.querySelector(`.tab-content[data-tab-content="${tabName}"]`).classList.add('active');
                });
            });
            
            // Toggle ASCII View
            toggleAsciiBtn.addEventListener('click', function() {
                if (asciiView.style.display === 'none') {
                    asciiView.style.display = 'block';
                    generateAsciiRepresentation();
                } else {
                    asciiView.style.display = 'none';
                }
            });
            
            // Clear Canvas
            clearBtn.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear the canvas? This action cannot be undone.')) {
                    canvas.innerHTML = '';
                    connections = [];
                    updateAsciiView();
                }
            });
            
            // Load Template
            loadTemplateBtn.addEventListener('click', function() {
                const templateType = templateSelect.value;
                loadTemplate(templateType);
            });
            
            // Export Diagram
            exportBtn.addEventListener('click', function() {
                alert('Export functionality would be implemented here. Options would include:\n- SVG Export\n- PNG Export\n- ASCII Text\n- JSON Data Structure');
            });
            
            // Handle Drag Start for Components
            function handleDragStart(e) {
                draggedElement = this;
                e.dataTransfer.setData('text/plain', this.getAttribute('data-type'));
                
                // Calculate offset to maintain mouse position relative to dragged element
                const rect = this.getBoundingClientRect();
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
            }
            
            // Handle Drag Over for Canvas
            function handleDragOver(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            }
            
            // Handle Drop of Components onto Canvas
            function handleDrop(e) {
                e.preventDefault();
                
                // Get component type and calculate position
                const componentType = e.dataTransfer.getData('text/plain');
                const canvasRect = canvas.getBoundingClientRect();
                
                // Calculate position with offset
                let posX = e.clientX - canvasRect.left - dragOffsetX;
                let posY = e.clientY - canvasRect.top - dragOffsetY;
                
                // Ensure we don't place elements outside the canvas
                posX = Math.max(0, posX);
                posY = Math.max(0, posY);
                
                // Create the element based on type
                createComponent(componentType, posX, posY);
                
                // Update ASCII view if visible
                if (asciiView.style.display !== 'none') {
                    generateAsciiRepresentation();
                }
            }
            
            // Create Component on Canvas
            function createComponent(type, x, y) {
                const id = `component-${currentId++}`;
                let element;
                
                switch(type) {
                    case 'location':
                        element = createLocationBox(id, x, y);
                        break;
                    case 'entity':
                        element = createEntityCircle(id, x, y);
                        break;
                    case 'goal':
                        element = createGoalBox(id, x, y);
                        break;
                    case 'obstacle':
                        element = createObstacleBox(id, x, y);
                        break;
                    case 'shift':
                        element = createShiftBox(id, x, y);
                        break;
                    case 'solution':
                        element = createSolutionBox(id, x, y);
                        break;
                    default:
                        return;
                }
                canvas.appendChild(element);
                makeDraggable(element);
                element.addEventListener('dblclick', () => openEditModal(element));
            }

            // --- COMPONENT FACTORY FUNCTIONS ---
            function createLocationBox(id, x, y) {
                const element = document.createElement('div');
                element.className = 'diagram-element location-box';
                element.id = id;
                element.setAttribute('data-type', 'location');
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.innerHTML = `<span>🏠 Location</span>`;
                return element;
            }
            function createEntityCircle(id, x, y) {
                const element = document.createElement('div');
                element.className = 'diagram-element entity-circle';
                element.id = id;
                element.setAttribute('data-type', 'entity');
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.innerHTML = `<span>🧑 Entity</span>`;
                return element;
            }
            function createGoalBox(id, x, y) {
                const element = document.createElement('div');
                element.className = 'diagram-element goal-box';
                element.id = id;
                element.setAttribute('data-type', 'goal');
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.innerHTML = `<span>🎯 Goal</span>`;
                return element;
            }
            function createObstacleBox(id, x, y) {
                const element = document.createElement('div');
                element.className = 'diagram-element obstacle-box';
                element.id = id;
                element.setAttribute('data-type', 'obstacle');
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.innerHTML = `<span>⛔ Obstacle</span>`;
                return element;
            }
            function createShiftBox(id, x, y) {
                const element = document.createElement('div');
                element.className = 'diagram-element shift-box';
                element.id = id;
                element.setAttribute('data-type', 'shift');
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.innerHTML = `<span>🔄 Shift</span>`;
                return element;
            }
            function createSolutionBox(id, x, y) {
                const element = document.createElement('div');
                element.className = 'diagram-element solution-box';
                element.id = id;
                element.setAttribute('data-type', 'solution');
                element.style.left = x + 'px';
                element.style.top = y + 'px';
                element.innerHTML = `<span>🏆 Solution</span>`;
                return element;
            }

            // --- DRAGGABLE LOGIC ---
            function makeDraggable(element) {
                element.draggable = true;
                element.addEventListener('dragstart', function(e) {
                    draggedElement = element;
                    dragOffsetX = e.offsetX;
                    dragOffsetY = e.offsetY;
                });
                element.addEventListener('dragend', function(e) {
                    if (draggedElement) {
                        const canvasRect = canvas.getBoundingClientRect();
                        let posX = e.clientX - canvasRect.left - dragOffsetX;
                        let posY = e.clientY - canvasRect.top - dragOffsetY;
                        posX = Math.max(0, posX);
                        posY = Math.max(0, posY);
                        element.style.left = posX + 'px';
                        element.style.top = posY + 'px';
                        draggedElement = null;
                        if (asciiView.style.display !== 'none') {
                            generateAsciiRepresentation();
                        }
                    }
                });
            }

            // --- MODAL LOGIC ---
            function openEditModal(element) {
                currentlyEditing = element;
                document.getElementById('component-name').value = element.querySelector('span').textContent;
                document.getElementById('component-description').value = element.getAttribute('data-description') || '';
                document.getElementById('component-color').value = rgbToHex(window.getComputedStyle(element).backgroundColor);
                document.getElementById('component-size').value = element.getAttribute('data-size') || 'medium';
                document.getElementById('component-id').value = element.id;
                document.getElementById('component-type').value = element.getAttribute('data-type');
                editModal.style.display = 'block';
            }
            function closeModal() {
                editModal.style.display = 'none';
                currentlyEditing = null;
            }
            function saveEdit() {
                if (!currentlyEditing) return;
                currentlyEditing.querySelector('span').textContent = document.getElementById('component-name').value;
                currentlyEditing.setAttribute('data-description', document.getElementById('component-description').value);
                currentlyEditing.style.backgroundColor = document.getElementById('component-color').value;
                currentlyEditing.setAttribute('data-size', document.getElementById('component-size').value);
                closeModal();
                if (asciiView.style.display !== 'none') {
                    generateAsciiRepresentation();
                }
            }
            function rgbToHex(rgb) {
                if (!rgb) return '#ffffff';
                const result = rgb.match(/\d+/g);
                if (!result) return '#ffffff';
                return '#' + result.slice(0,3).map(x=>(+x).toString(16).padStart(2,'0')).join('');
            }

            // --- ASCII REPRESENTATION ---
            function generateAsciiRepresentation() {
                // Simple ASCII grid representation
                let ascii = '+------------------------+\n';
                let elements = Array.from(canvas.children);
                elements.forEach(el => {
                    ascii += `| ${el.getAttribute('data-type').padEnd(9)} | ${el.querySelector('span').textContent.padEnd(12)} |\n`;
                });
                ascii += '+------------------------+';
                asciiView.textContent = ascii;
            }
            function updateAsciiView() {
                if (asciiView.style.display !== 'none') {
                    generateAsciiRepresentation();
                }
            }

            // --- CONNECTION LOGIC ---
            function chooseRelation(t1, t2) {
                if(t1==='entity'&&t2==='location') return 'is at';
                if(t1==='entity'&&t2==='goal') return 'seeks';
                if(t1==='entity'&&t2==='obstacle') return 'faces';
                if(t1==='entity'&&t2==='shift') return 'can perform';
                if(t1==='entity'&&t2==='solution') return 'achieves';
                if(t1==='goal'&&t2==='location') return 'is in';
                if(t1==='obstacle'&&t2==='location') return 'blocks';
                if(t1==='obstacle'&&t2==='goal') return 'blocks';
                if(t1==='shift'&&t2==='obstacle') return 'resolves';
                if(t1==='solution'&&t2==='goal') return 'fulfills';
                return null;
            }

            connectBtn.addEventListener('click', function() {
                connectMode = !connectMode;
                connectBtn.classList.toggle('active', connectMode);
                connectFrom = null;
            });

            // Handle block click for connection
            canvas.addEventListener('click', function(e) {
                if (!connectMode) return;
                const target = e.target.closest('.diagram-element');
                if (!target) return;
                if (!connectFrom) {
                    connectFrom = target;
                    target.classList.add('highlight');
                } else if (target !== connectFrom) {
                    // Semantic relation check
                    const typeFrom = connectFrom.getAttribute('data-type');
                    const typeTo = target.getAttribute('data-type');
                    const rel = chooseRelation(typeFrom, typeTo);
                    if (!rel) {
                        alert(`No valid LEGOS relation from ${typeFrom} to ${typeTo}.`);
                        connectFrom.classList.remove('highlight');
                        connectFrom = null;
                        return;
                    }
                    // Create connection with relation
                    connections.push({from: connectFrom.id, to: target.id, relation: rel});
                    connectFrom.classList.remove('highlight');
                    connectFrom = null;
                    renderArrows();
                }
            });

            function renderArrows() {
                arrowSVG.innerHTML = `
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="strokeWidth">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#3a7ca5"/>
                        </marker>
                    </defs>`;
                connections.forEach(conn => {
                    const from = document.getElementById(conn.from);
                    const to = document.getElementById(conn.to);
                    if (!from || !to) return;
                    const fromRect = from.getBoundingClientRect();
                    const toRect = to.getBoundingClientRect();
                    const canvasRect = canvas.getBoundingClientRect();
                    const x1 = fromRect.left + fromRect.width/2 - canvasRect.left;
                    const y1 = fromRect.top + fromRect.height/2 - canvasRect.top;
                    const x2 = toRect.left + toRect.width/2 - canvasRect.left;
                    const y2 = toRect.top + toRect.height/2 - canvasRect.top;
                    const midX = (x1 + x2) / 2;
                    const midY = (y1 + y2) / 2;
                    arrowSVG.innerHTML += `<line class='arrow-line' x1='${x1}' y1='${y1}' x2='${x2}' y2='${y2}' />`;
                    // Add relation label
                    arrowSVG.innerHTML += `<text class='arrow-label' x='${midX}' y='${midY - 8}'>${conn.relation}</text>`;
                });
            }

            // Re-render arrows on move
            const observer = new MutationObserver(renderArrows);
            observer.observe(canvas, {childList: true, subtree: true, attributes: true, attributeFilter: ['style']});
            window.addEventListener('resize', renderArrows);

            // --- TEMPLATES ---
            const templates = {
                minimal: {
                    blocks: [
                        {id:"loc1",type:"location",label:"Home",x:100,y:200},
                        {id:"ent1",type:"entity",label:"Hero",x:300,y:200},
                        {id:"goal1",type:"goal",label:"Treasure",x:500,y:200},
                        {id:"obs1",type:"obstacle",label:"Wall",x:400,y:350},
                        {id:"shift1",type:"shift",label:"Jump",x:400,y:100},
                        {id:"sol1",type:"solution",label:"Victory",x:600,y:200}
                    ],
                    connections: [
                        {from:"ent1",to:"loc1",relation:"is at"},
                        {from:"ent1",to:"goal1",relation:"seeks"},
                        {from:"ent1",to:"obs1",relation:"faces"},
                        {from:"ent1",to:"shift1",relation:"can perform"},
                        {from:"shift1",to:"obs1",relation:"resolves"},
                        {from:"sol1",to:"goal1",relation:"fulfills"},
                        {from:"ent1",to:"sol1",relation:"achieves"}
                    ]
                },
                cyber: {
                    blocks: [
                        {id:"loc1",type:"location",label:"Lab",x:120,y:200},
                        {id:"ent1",type:"entity",label:"Scientist",x:320,y:120},
                        {id:"goal1",type:"goal",label:"Discovery",x:520,y:200},
                        {id:"obs1",type:"obstacle",label:"Noise",x:420,y:350},
                        {id:"shift1",type:"shift",label:"Feedback",x:320,y:320},
                        {id:"sol1",type:"solution",label:"Insight",x:620,y:200}
                    ],
                    connections: [
                        {from:"ent1",to:"loc1",relation:"is at"},
                        {from:"ent1",to:"goal1",relation:"seeks"},
                        {from:"obs1",to:"goal1",relation:"blocks"},
                        {from:"shift1",to:"obs1",relation:"resolves"},
                        {from:"ent1",to:"shift1",relation:"can perform"},
                        {from:"sol1",to:"goal1",relation:"fulfills"},
                        {from:"ent1",to:"sol1",relation:"achieves"}
                    ]
                },
                quest: {
                    blocks: [
                        {id:"loc1",type:"location",label:"Village",x:100,y:300},
                        {id:"ent1",type:"entity",label:"Adventurer",x:250,y:200},
                        {id:"goal1",type:"goal",label:"Artifact",x:500,y:100},
                        {id:"obs1",type:"obstacle",label:"Dragon",x:400,y:250},
                        {id:"shift1",type:"shift",label:"Magic Spell",x:350,y:350},
                        {id:"sol1",type:"solution",label:"Peace",x:600,y:300}
                    ],
                    connections: [
                        {from:"ent1",to:"loc1",relation:"is at"},
                        {from:"ent1",to:"goal1",relation:"seeks"},
                        {from:"ent1",to:"obs1",relation:"faces"},
                        {from:"shift1",to:"obs1",relation:"resolves"},
                        {from:"ent1",to:"shift1",relation:"can perform"},
                        {from:"sol1",to:"goal1",relation:"fulfills"},
                        {from:"ent1",to:"sol1",relation:"achieves"}
                    ]
                }
            };

            function loadTemplate(templateKey) {
                // Clear canvas
                canvas.innerHTML = '';
                connections = [];
                // Place blocks
                templates[templateKey].blocks.forEach(b => {
                    let el;
                    switch(b.type) {
                        case 'location': el = createLocationBox(b.id, b.x, b.y); break;
                        case 'entity': el = createEntityCircle(b.id, b.x, b.y); break;
                        case 'goal': el = createGoalBox(b.id, b.x, b.y); break;
                        case 'obstacle': el = createObstacleBox(b.id, b.x, b.y); break;
                        case 'shift': el = createShiftBox(b.id, b.x, b.y); break;
                        case 'solution': el = createSolutionBox(b.id, b.x, b.y); break;
                    }
                    el.querySelector('span').textContent = b.label ? b.label : el.querySelector('span').textContent;
                    canvas.appendChild(el);
                    makeDraggable(el);
                    el.addEventListener('dblclick', () => openEditModal(el));
                });
                // Add connections
                templates[templateKey].connections.forEach(c => {
                    connections.push({from: c.from, to: c.to, relation: c.relation});
                });
                renderArrows();
                if (asciiView.style.display !== 'none') generateAsciiRepresentation();
            }

            document.getElementById('template-minimal').onclick = () => loadTemplate('minimal');
            document.getElementById('template-cyber').onclick = () => loadTemplate('cyber');
            document.getElementById('template-quest').onclick = () => loadTemplate('quest');
        });
    </script>
</body>
</html>